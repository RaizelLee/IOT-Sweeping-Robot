# IOT-Sweeping-Robot
# 1091學期 CS348物聯網與微處理機系統設計 期末專題報告
主題：掃地機器人
===

成員：1041636李亞珍、1071549周皓、1073503蔡孟庭
 
## 一、    	成員名單與分工：
·       李亞珍：
發想、編寫演算法，演算法包括：自走車初始化、行走空間地面周長、計算空間地面面積、行走全面積的演算法

·   	周皓：
想演算法（演算法同上）、修改與編寫演算法、硬體發想

·   	蔡孟庭：
設計硬體架構、建置硬體設備、修正硬體問題
 
## 二、    	專題功能說明：
　　本專題的內容為藉由自走車模擬掃地機器人的行走模式。在本專案中該自走車以樹梅派作為開發系統，並且掛載超音波感測器、馬達(驅動車輪)以及行動電源等基礎設備來作為開發環境。若本裝置裝設吸塵模組即可以作為掃地機器人使用，成為居家維護及保持環境清潔的便利工具。
  
　　我們的自走車運行方式為：首先，先將空間周圍的路徑行走一遍後記錄下行走的過程，形成一個周長座標圖，再以此周長座標圖計算出空間的面積與車輛總共行走的路徑。
  
　　而自走車的起始位置分為兩種：起始點車身微靠牆面、車身放置於任意空曠地面（周邊無牆面）。目標為設計出行走模式能夠涵蓋整體空間地面的演算法。若起始位置為車身微靠牆面的情況，則分為初始靠左側牆面行走或是初始靠右側牆行走。在進行初步的路徑分析後，再經由此條件分析和判斷自走車行走時遇到各種路況時貼著牆邊行走的路徑。反之若車身起始位置放置於任意空曠的平面上，車身將走向距離最近的牆面行走貼近牆面，達成車身為靠牆面的情況，再進行繞境和行走平面全面積的過程。

## 三、    	操作與執行流程：
　　利用樹梅派開始執行演算法後（python code），過程如下：
1.  車身位置初始化：
透過車身前、左、右方超音波感測器，偵測車身與三面牆面間的距離，演算法計算出最近的牆面後，自走車將會行走貼近該牆面，並旋轉用側面車身貼近牆面，完成位置的初始化，該位置即為起點（座標為(0,0)）。
2.  依牆繞境，製作周長座標圖：
當自走車找到起始位置後，會開始透過超音波感測器，持續的測量車身與前、左、右方的牆面距離。再透過演算法判斷各種路況，來控制自走車持續貼著同一側牆面繞巡該空間地面一圈。並在演算法中用一維陣列儲存周長上的所有座標，直到回到起點（座標(0,0)）為止。
座標的儲存方式為：
車子向相對於起點的前方直行，y座標+1
車子向相對於起點的左方直行，x座標-1
車子向相對於起點的右方直行，x座標+1
車子向相對於起點的前方直行，y座標-1
3.  使自走車走過整個空間地面，完成工作：
當自走車行駛完一圈回到原點後，演算法將會計算，將空間面積劃分出幾個區域，來控制車子依序行走掃過所有面積。
演算法步驟：
a)  生成涵蓋整個空間的長方形座標地圖（用二維陣列儲存）
　周長的邊緣地帶：先使用值１儲存於陣列，代表已走過
　周長內的待掃的面積：使用值０表示，代表需行走且還未行走
　周長外的面積：使用值４儲存於陣列，代表不能行走的區域
b)  將所有待行走面積(值為0的區域)，分割成許多長方形區塊(連續的面積會被分割成一塊)，每個區塊的座標儲存至陣列中，並將所有區塊，進一步包裝成一個大陣列(components_array)
c)  依序讀取components_array裡的各個區塊中的座標，並且控制自走車依循行走至各個座標，結果會使自走車將每個區塊橫向依序走過，完成掃好整個空間地面



### 以下為自走車行駛畫面：
![](https://i.imgur.com/PTMachs.png)

![](https://i.imgur.com/QDmUDf0.png)

![](https://i.imgur.com/zxdY0W7.png)

![](https://i.imgur.com/SDCjJbx.png)

![](https://i.imgur.com/0Ix8P7a.png)


## 四、  	  硬體電路示意圖
![](https://i.imgur.com/tY6Ud1d.png)

使用元件：
1.	HC-SR04超音波感測器 *3 ：置於車身的前、左、右方，即時感測車身與牆面距離
2.	10k可變電阻 *3 ：調整超音波感測器的電壓
3.	行動電源 *1 ：供電給樹梅派和馬達
4.	馬達 *2 ：控制兩個車輪
 
  

## 五、軟體程式執行流程圖：
![](https://i.imgur.com/TfX36qH.png)

各個函式和變數的功能：
1.	main(): 控制自走車演算法的整體流程。
2.	start(): 當自走車啟動，將自走車控制行走至牆邊，初始化起點位置。
3.	at_start_record_size: True代表在紀錄周長的階段，False代表在初始化階段，或是在行走全面積階段。
4.	distance(GPIO_TRIGGER,GPIO_ECHO): 使超音波感測器回傳該改測器與牆面的距離，回傳距離值，用於前、左、右方超音波感測器。
5.	against_the_wall(GPIO_TRIGGER,GPIO_ECHO):使超音波感測器回傳該改測器與牆面的距離後判斷是否靠近牆面，回傳值若是True代表靠近牆面，若是False代表離牆面有一段距離，用於判斷車身前、左、右方是否靠牆。
6.	action_truth_table(wall_f, wall_r, wall_l, start_direction): 當車子在行走時，遇到各種路況時，進入此函式判斷車子該如何走下一步，並且使用at_start_record_size變數加入當其中一項判斷條件。
7.	forward():控制車身前進，並且在記錄周長座標階段即時記錄行走座標。
8.	turnRight(): 控制車身右轉。
9.	turnLeft(): 控制車身左轉。
10.	backward(): 控制車身後退。
11.	stop(): 使車身停止移動。

## 六、    	參考的課程實驗或是網路資源：
HC-SR04 超音波感測器：

●	TAIWAN TECH Raspberry Pi Lab　

https://sites.google.com/site/rasberrypintust/shu-mei-pai-xiao-ji-qiao/8-hc-sr04-chao-yin-bo-gan-ce-qi

●	tutorials-raspberrypi.com

https://tutorials-raspberrypi.com/raspberry-pi-ultrasonic-sensor-hc-sr04/

●	blog.everlearn.tw

https://blog.everlearn.tw/%E7%95%B6-python-%E9%81%87%E4%B8%8A-raspberry-pi/raspberry-pi-3-model-b-%E8%88%87-hc-sr04-%E8%B6%85%E9%9F%B3%E6%B3%A2%E6%84%9F%E6%B8%AC%E5%99%A8%E4%B9%8B%E6%87%89%E7%94%A8
 
## 七、    	開發最耗時的部份與原因：
　　在做的過程中，我們覺得最耗時與困難的部分為：解決硬體問題和構想掃地機器人演算法的部分。
  
　　硬體部分的問題：
  
因為硬體配備的穩定度沒有想像中的高，所以絕大部分必須靠軟體的運算來補足，像是：馬達只有通電秒數的長短，所以要向左或向右轉彎九十度的話必須算好左右輪的通電秒數；還有電容放電太慢需要等待電容完全放完電後，才能進行下一個轉彎的動作，否則會因為電容裡的電還沒放完就充入電，導致馬達的通電時間變長，影響到了轉彎的時間，故而轉過頭，造成面積的計算錯誤。

此外電壓的供應不穩定，造成供應給馬達的電也不穩定，進而影響到了行走時左右輪轉數不一樣，所以走直線時會忽左忽右。除此之外，要如何畫出掃地機器人需要掃的空間面積大小，以及要如何規劃掃地機器人要的區域先後順序，甚至記錄下哪塊區域已掃過，哪塊區域尚未掃過，這些都是掃地機器人的一部分，故在此上耗費了許多天去克服這些難關，雖然最後硬體的部分並沒有完全解決，但是在這個過程之中也讓我們學習到了，要如何利用軟體盡量的去補足硬體缺失的部分。

　　演算法的部分：
  
　　演算法除了以上提及的需要修正硬體造成的誤差（車子旋轉角度難以控制在90度、車子行走時車身會右偏，需要即時修正等等），也需要分類各種路況來控制車身的行走方向，以及即時記錄座標、畫出周長並加以計算需要掃過的整體空間面積，排除障礙物，更要將面積透過演算法紀錄是否行走過，以及將待行走的地面面積切分成多個部分，依序行走。以上都需要使車身到達精準地位置才可以進行不同的行走控制。但因為超音波感測器的距離精準度不佳，以及車子馬達的轉彎和直行都難以控制，因此實現上變得很困難。且這些演算法都需要非常複雜的計算，讓我們編寫了將近800行的程式碼，覺得是十分複雜且困難的編寫過程。

 
## 八、展示完整專題流程之影片，上傳至任何平台並提供網址：
IOT物聯網B班_23組_掃地機器人Demo影片(Youtube)：
https://youtu.be/xpcjWRMVTcU
 
 

